# CTR/CVR 建模技术综述与演进总结

## 一、两阶段 Pipeline 建模

两阶段建模是 CTR/CVR 预测的经典范式，其核心思想是将用户行为序列"曝光 →
点击 → 转化"拆解为两个独立阶段。

### 1️⃣ CTR 模型阶段

目标是预测用户对曝光内容的点击概率 P(点击\|曝光)。CTR
模型的数据量大且样本平衡度高，主要关注用户兴趣与内容匹配度特征，如用户画像、商品属性、上下文环境等。\
模型结构从早期的 **LR + 手工特征**，发展到 **Wide&Deep、DeepFM**
等深度架构，能有效捕捉高阶特征交互。

### 2️⃣ CVR 模型阶段

目标是预测
P(转化\|点击)，即点击后的转化概率。其主要挑战在于样本稀疏与选择偏差（仅点击样本可用）。CVR
模型多使用浅层神经网络或线性模型，并关注与转化相关的特征，如价格、购买力、历史交易等。

### 3️⃣ 模型融合策略

最终得分常通过加权乘积得到：\
`Score = CTR^α × CVR^β × other_factors`\
例如，美团外卖采用：\
`finalScore = CTR^0.4 × CVR^0.3 × (GMV/AvgGMV)^0.2 × ETA_penalty`\
这种设计平衡了点击率与转化率，兼顾商业收益。

### 4️⃣ 优势与局限

Pipeline 方法结构简单、易维护、计算成本低，但存在 **误差传递**、**CVR
数据稀疏**、**阶段关联弱** 等问题。

------------------------------------------------------------------------

## oCPM 与 eCPM：从模型到商业目标的衔接 （添加）

CTR/CVR 模型的最终目标是服务于广告或推荐系统中的收益优化，而 **eCPM（Effective Cost Per Mille）** 与 **oCPM（Optimized Cost Per Mille）** 是连接预测模型与商业收益的关键指标。

### 1️⃣ eCPM：效果驱动的基础指标
eCPM 表示单位曝光带来的预期收益，定义为：  
\[
eCPM = \frac{收益}{曝光数} × 1000 = bid × CTR × CVR × 1000
\]  
其中 *bid* 表示出价，CTR 表示点击率预测值，CVR 表示转化率预测值。  
eCPM 是广告系统排序的核心依据，用于在拍卖中评估每次曝光的潜在商业价值。它能统一衡量不同广告或推荐内容的收益贡献，从而实现“收益最大化”的全局优化目标。

### 2️⃣ oCPM：智能出价的进阶机制
oCPM（Optimized CPM）是基于 eCPM 的动态出价策略，通过结合 **CTR/CVR 预测结果** 与 **转化目标** 实现自动化优化。其核心思想是：  
> 广告主不再直接为每次曝光付费，而是设定一个转化目标（如点击、下单或注册），系统根据预测的转化概率动态调整出价。

典型公式为：  
\[
bid_{ocpm} = base\_bid × \frac{P(转化|曝光)}{P_{avg}(转化|曝光)}
\]  
其中 base_bid 是广告主期望的平均出价，P(转化|曝光) 可由 CTR×CVR 估计。

### 3️⃣ 模型与策略的协同优化
oCPM 的实现依赖于精确的 CTR 与 CVR 预测。CTR 决定点击意愿，CVR 衡量转化潜力，两者共同决定 eCPM / oCPM 排序得分：  
\[
score = bid × CTR × CVR
\]  
因此，CTR/CVR 的优化直接决定平台收益和广告主 ROI（Return on Investment）。  
在工业系统中，平台常基于 oCPM 框架构建强化学习或多任务优化模型，以动态平衡 **曝光分配、点击率、转化率与收益目标**，形成从预测到出价的闭环。

### 4️⃣ 实际应用中的考量
- **延迟反馈问题**：转化事件往往滞后于点击，需采用延迟建模或标签修正。  
- **预算与频控**：oCPM 需结合广告主预算约束与频次控制策略。  
- **跨任务目标冲突**：CTR 优化可能提升流量但未必带来收益，需联合优化 CVR/GMV 等指标。

------------------------------------------------------------------------

## 二、ESMM：端到端联合建模

ESMM（Entire Space Multi-Task Model）以多任务学习方式实现 CTR 与 CVR
的联合建模，有效缓解 Pipeline 的缺陷。

### 1️⃣ 模型结构

ESMM 同时预测 CTR（P(点击\|曝光)）与
CTCVR（P(转化,点击\|曝光)），通过双塔结构建模：\
- CTR 子网负责点击预测；\
- CVR 子网负责转化预测；\
两者共享底层嵌入层表示，最终 CTCVR = CTR × CVR。\
共享机制使 CVR 能借助全量曝光样本间接学习，缓解数据稀疏问题。

### 2️⃣ 损失函数设计

ESMM 采用联合损失：\
`L = L_CTR + λ L_CTCVR`\
其中 L_CTR、L_CTCVR 均为交叉熵损失，CVR 参数通过 CTCVR
间接更新，无需单独损失项。

### 3️⃣ 参数共享的收益

共享嵌入层不仅减少了模型参数与训练样本需求，还实现了表示迁移，使 CVR
能从 CTR 的大规模样本中受益。在阿里数据实验中，点击样本占比仅 4%，但 CVR
通过共享仍能有效学习。

### 4️⃣ 后续改进

-   **ESM²**：引入更多中间行为（如加购、收藏）细化转化路径；\
-   **ESMM + MoE**：融合 Mixture of Experts 提升表达能力；\
-   **ESCM²**：结合因果推断校正偏差，增强 CVR 估计准确性。

------------------------------------------------------------------------

## 三、CVR 样本偏差修正技术

CVR
模型因仅在点击样本上训练而在全曝光上推理，导致样本选择偏差。以下技术用于修正：

### 1️⃣ IPS（Inverse Propensity Scoring）

通过点击概率 P(点击\|x) 的倒数为样本加权，近似还原曝光分布。\
`L_IPS = (1/N) ∑[δ(Y, Ŷ) / P(o=1|x)]`\
尽管理论上无偏，但倾向得分估计误差可能引发方差爆炸。

### 2️⃣ 因果推断方法

通过因果图建模"曝光→点击→转化"路径，识别并消除混杂变量影响。如 DCMT
框架引入反事实机制，对事实与反事实 CVR 一致性施加约束，实现无偏估计。

### 3️⃣ 混合方法

ESCM² 将 IPS 与双稳健（DR）方法结合，通过反事实风险最小化：\
`L = L_CTR + λ L_CTCVR + μ L_CVR_CR`\
在 Ali-CCP 数据集上显著降低 CVR 偏差，提升泛化能力。

### 4️⃣ 工业实践要点

-   **倾向得分校准**：通过 Expected Calibration Error (ECE)
    提高可信度；\
-   **权重裁剪**：避免过大权重方差（如裁剪到 \[0.001, 0.999\]）；\
-   **冷启动处理**：针对新用户/商品采用特殊策略。

------------------------------------------------------------------------

## 四、多任务学习架构创新

多任务学习（MTL）已成为 CTR/CVR 建模主流，通过共享特征增强泛化。

-   **MMoE（Multi-gate Mixture of
    Experts）**：每个任务通过门控网络动态选择专家，缓解任务冲突与负迁移。\
-   **PLE（Progressive Layered
    Extraction）**：引入共享与任务专属专家的层次化结构，兼顾共享与独立性。\
-   **MAN（Multi-task Attention
    Network）**：结合注意力机制动态建模任务相关性，在 Ali-CCP 上优于传统
    MTL 架构。

------------------------------------------------------------------------

## 五、数学原理与工程实践

### 5.1 核心算法原理

-   **LR（逻辑回归）**\
    `P(y=1|x) = σ(w^T x + b)`\
    结构简单但仅能建模线性关系。

-   **FM（因子分解机）**\
    `y = σ(w^T x + x^T W^T W x)`\
    引入隐向量以建模高阶特征交互，复杂度从 O(n²) 降至 O(nk)。

-   **深度模型（Wide&Deep）**\
    通过 Embedding + MLP 自动学习高阶交互，减少人工特征工程依赖。

-   **MTL 理论框架**\
    `min_θ ∑_{t=1}^T L_t(f_t(x;θ), y_t) + Ω(θ)`\
    如 ESMM 利用共享嵌入实现 CTR→CVR 的迁移学习。

### 5.2 损失函数与优化策略

-   **Point-wise**：交叉熵、MSE、Focal Loss\
-   **Pair-wise**：BPR Loss、Hinge Loss、RankNet\
-   **List-wise**：ListMLE、NDCG Loss\
-   **特殊损失**：ESMM 联合损失、IPS 加权、反事实损失

**优化算法**\
- FTRL：适用于在线与稀疏特征\
- Adagrad：自适应稀疏学习率\
- Adam：深度模型标准选择

------------------------------------------------------------------------

## ✅ 总结

CTR/CVR 建模经历了从 **Pipeline 分阶段 → ESMM 端到端 → 偏差修正 →
多任务架构创新** 的技术演进。\
发展方向逐步从结构解耦走向参数共享，从经验驱动走向理论支撑，从单一任务预测迈向联合建模与因果学习，实现了预测精度与商业价值的双提升。
